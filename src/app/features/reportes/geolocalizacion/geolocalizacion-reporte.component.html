<!-- src/app/features/reportes/geolocalizacion/geolocalizacion-reporte.component.html -->

<div class="vendedores-geoloc-container">
  <!-- Panel Izquierdo -->
  <div class="left-panel">
    <!-- Estado de carga/error -->
    <div class="status-section" *ngIf="loading() || error()">
      <div class="loading-indicator" *ngIf="loading()">
        <div class="spinner"></div>
        <span>Cargando vendedores...</span>
      </div>

      <div class="error-indicator" *ngIf="error()">
        <span class="error-icon">⚠️</span>
        <span>{{ error() }}</span>
        <button class="retry-btn" (click)="refresh()">Reintentar</button>
      </div>
    </div>


    <!-- Controles de filtrado -->
    <div class="controls-section" *ngIf="!loading()">
      <!-- Buscador mejorado -->
      <div class="search-box">
        <input
          type="text"
          placeholder="🔍 Buscar vendedores..."
          [(ngModel)]="searchTerm"
          (input)="filtrarVendedores()"
          [disabled]="loading()"
          aria-label="Buscar vendedores"
        />
        <button class="btn" (click)="filtrarVendedores()" [disabled]="loading()" aria-label="Buscar">
          <span>🔍</span>
        </button>
      </div>

      <!-- Filtros compactos -->
      <div class="filter-estados">
        <button
          class="filter-chip"
          [class.active]="filtroEstado === 'todos'"
          (click)="onFiltroEstadoChange('todos')"
          [disabled]="loading()">
          Todos
        </button>
        <button
          class="filter-chip"
          [class.active]="filtroEstado === 'activo'"
          (click)="onFiltroEstadoChange('activo')"
          [disabled]="loading()">
          ✓ Activos
        </button>
        <button
          class="filter-chip"
          [class.active]="filtroEstado === 'inactivo'"
          (click)="onFiltroEstadoChange('inactivo')"
          [disabled]="loading()">
          ⏸ Inactivos
        </button>
      </div>
    </div>

    <!-- Lista de vendedores optimizada -->
    <div class="list-vendedores" *ngIf="!loading() && !error()">
      <div
        *ngFor="let v of vendedoresFiltrados; trackBy: trackByVendedorId"
        class="v-item"
        [class.selected]="selectedVendedorId === v.id"
        (click)="centrarEnVendedorClick(v)"
        [attr.aria-label]="'Vendedor ' + v.nombre + ' ' + (v.apellidos || '')"
        tabindex="0"
        (keydown.enter)="centrarEnVendedorClick(v)"
        (keydown.space)="centrarEnVendedorClick(v); $event.preventDefault()">

        <div class="v-info">
          <div class="v-name">
            <span class="name-primary">{{ v.nombre }}</span>
            <small *ngIf="v.apellidos" class="name-secondary">{{ v.apellidos }}</small>
            <span class="v-codigo">{{ v.codigo }}</span>
            <span class="v-status" [ngClass]="v.estado || 'default'">
              {{ getEstadoIcon(v.estado || 'default') }} {{ v.estado || 'Sin estado' }}
            </span>
          </div>

          <div class="v-meta">
            <div class="meta-row" *ngIf="v.direccion">
              📍 {{ v.direccion }}
            </div>
            <div class="meta-row" *ngIf="v.ciudad || v.zona">
              🏢 {{ v.ciudad || v.zona }}
            </div>
            <div class="meta-row" *ngIf="v.telefono">
              📞 {{ v.telefono }}
            </div>
            <div class="meta-row" *ngIf="v.ruc">
              💼 {{ v.ruc }}
            </div>
          </div>
          <!-- Eliminadas las estadísticas v-stats -->
        </div>
      </div>

      <!-- Estado vacío -->
      <div class="empty" *ngIf="vendedoresFiltrados.length === 0 && !loading()">
        <div class="empty-content">
          <span class="empty-icon">🔍</span>
          <p>No se encontraron vendedores</p>
          <small *ngIf="searchTerm || filtroEstado !== 'todos'">
            Intenta con otro término o ajusta los filtros
          </small>
          <small *ngIf="!searchTerm && filtroEstado === 'todos'">
            No hay vendedores registrados
          </small>
        </div>
      </div>
    </div>

    <!-- Controles de paginación con iconos -->
    <div class="pagination-controls" *ngIf="paginacion && paginacion.totalPaginas > 1 && !loading()">
      <button
        class="pagination-btn"
        [disabled]="!paginacion.tienePaginaAnterior"
        (click)="onPaginaAnterior()"
        aria-label="Anterior">
        <span class="material-icons">chevron_left</span>
      </button>

      <div class="pagination-info-detailed">
        <span>{{ paginacion.paginaActual }} / {{ paginacion.totalPaginas }}</span>
      </div>

      <button
        class="pagination-btn"
        [disabled]="!paginacion.tienePaginaSiguiente"
        (click)="onPaginaSiguiente()"
        aria-label="Siguiente">
        <span class="material-icons">chevron_right</span>
      </button>
    </div>
    <!-- Información de paginación compacta -->
    <div class="pagination-info" *ngIf="paginacion && !loading()">
      <small>{{ getPaginaInicio() }} - {{ getPaginaFin() }} de {{ paginacion.totalRegistros }}</small>
    </div>
  </div>

  <!-- Panel Derecho - Mapa -->
  <div class="right-panel">
    <div class="map-header">
      <!-- Información de vendedores -->
      <div class="header-vendedores">
        <div class="header-title">
          <h2>👥 Vendedores</h2>
          <!-- Mostrar empresa seleccionada -->
          <div class="empresa-info" *ngIf="empresaSeleccionada">
            <small>📊 {{ empresaNombre }}</small>
          </div>
          <button
            class="btn ghost"
            (click)="obtenerMiUbicacion()"
            aria-label="Mi ubicación">
            📍 Mi Ubicación
          </button>

        </div>
      </div>


      <!-- Status del mapa -->
      <div class="header-mapa">
        <div class="status">
          <span [ngClass]="{'loading-shimmer': mapLoading}">{{ mapStatus }}</span>
        </div>
      </div>
    </div>

    <div class="location-search-container">
      <div class="location-search-wrapper">
        <!-- Input de búsqueda -->
        <div class="location-search-input-group">
          <span class="search-icon">🔍</span>
          <input
            type="text"
            class="location-search-input"
            placeholder="Buscar ubicación en Ecuador..."
            [(ngModel)]="locationSearchTerm"
            (input)="onLocationSearchInput($event)"
            (focus)="onLocationSearchFocus()"
            (blur)="onLocationSearchBlur($event)"
            autocomplete="off"
            spellcheck="false"
            [disabled]="loading()"
          />
          <button
            class="search-clear-btn"
            *ngIf="locationSearchTerm"
            (click)="clearLocationSearch()"
            type="button"
            aria-label="Limpiar búsqueda">
            ✕
          </button>
          <button
            class="search-location-btn"
            (click)="performLocationSearchFromInput()"
            [disabled]="!locationSearchTerm || isSearchingLocation"
            type="button"
            aria-label="Buscar ubicación">
            <span *ngIf="!isSearchingLocation">📍</span>
            <span *ngIf="isSearchingLocation" class="spinner-small"></span>
          </button>
        </div>

        <!-- Sugerencias dropdown -->
        <div
          class="location-suggestions-dropdown"
          [class.show]="showLocationSuggestions && (locationSuggestions.length > 0 || isSearchingLocation)">

          <!-- Estado de carga -->
          <div class="location-suggestion-item loading" *ngIf="isSearchingLocation">
                  <span class="suggestion-icon">
                    <div class="spinner-small"></div>
                  </span>
            <div class="suggestion-content">
              <div class="suggestion-name">Buscando ubicaciones...</div>
              <div class="suggestion-address">Consultando mapa de Ecuador</div>
            </div>
          </div>

          <!-- Resultados -->
          <div
            *ngFor="let suggestion of locationSuggestions; let i = index"
            class="location-suggestion-item"
            [class.selected]="selectedSuggestionIndex === i"
            (click)="selectLocationSuggestion(suggestion, i)"
            (mouseenter)="selectedSuggestionIndex = i">

            <div class="suggestion-content">
              <div class="suggestion-name">{{ extractLocationName(suggestion) }}</div>
              <div class="suggestion-address">{{ extractLocationAddress(suggestion) }}</div>
            </div>
          </div>

          <!-- Sin resultados -->
          <div class="location-suggestion-item no-results" *ngIf="!isSearchingLocation && locationSuggestions.length === 0 && locationSearchTerm && locationSearchTerm.length > 2">
            <span class="suggestion-icon">🔍</span>
            <div class="suggestion-content">
              <div class="suggestion-name">Sin resultados</div>
              <div class="suggestion-address">No se encontraron ubicaciones para "{{ locationSearchTerm }}"</div>
            </div>
          </div>
        </div>

      </div>
      <!-- Ubicación actual -->
      <div class="current-location-info" *ngIf="currentLocationName">
        <span class="location-pin">📍</span>
        <span class="location-text">{{ currentLocationName }}</span>
        <button class="clear-location-btn" (click)="clearCurrentLocation()" aria-label="Limpiar ubicación">
          ✕
        </button>
      </div>
    </div>

    <!-- Contenedor del mapa -->
    <div class="leaflet-map">
      <div id="geoloc-map" #mapContainer style="width: 100%; height: 100%;"></div>

      <!-- Leyenda flotante -->
      <div class="map-legend-floating" *ngIf="!loading() && !error() && vendedoresFiltrados.length > 0">
        <div class="legend-title">Leyenda</div>
        <div class="legend-item">
          <span class="legend-dot" style="background: #10b981;"></span>
          <span>Activos ({{ estadisticas.activos }})</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot" style="background: #ef4444;"></span>
          <span>Inactivos ({{ estadisticas.inactivos }})</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot" style="background: #1976d2; animation: pulse 2s infinite;"></span>
          <span>Tu Ubicación</span>
        </div>
      </div>

      <!-- Overlay de carga -->
      <div class="map-loading" *ngIf="mapLoading">
        <div class="spinner" aria-hidden="true"></div>
        <div>
          <strong>{{ mapStatus }}</strong>
          <br>
          <small>Preparando mapa con detalles de calles...</small>
        </div>
      </div>

      <!-- Overlay de error -->
      <div class="map-error" *ngIf="error() && !mapLoading">
        <div class="error-content">
          <span class="error-icon">⚠️</span>
          <strong>Error cargando datos</strong>
          <p>{{ error() }}</p>
          <button class="retry-btn" (click)="refresh()">Reintentar</button>
        </div>
      </div>

      <!-- Overlay sin datos -->
      <div class="map-no-data" *ngIf="!loading() && !error() && vendedoresFiltrados.length === 0 && !mapLoading">
        <div class="no-data-content">
          <span class="no-data-icon">📍</span>
          <strong>Sin vendedores para mostrar</strong>
          <p>No hay vendedores que coincidan con los filtros</p>
        </div>
      </div>
    </div>
  </div>

  <p-dialog
    header="Actualizar Ubicación de Vendedor"
    [(visible)]="showLocationUpdateDialog"
    [modal]="true"
    [style]="{ width: '500px', minHeight: '600px' }"
    [maximizable]="false"
    [closable]="true"
    styleClass="location-update-dialog">

    <!-- Header del modal con información del vendedor -->
    <ng-template pTemplate="header">
      <div class="flex align-items-center gap-3">
        <i class="pi pi-map-marker text-2xl text-primary"></i>
        <div>
          <h3 class="m-0 text-primary">Actualizar Ubicación</h3>
          <p class="m-0 text-sm text-color-secondary" *ngIf="selectedVendedorForUpdate">
            {{ selectedVendedorForUpdate.nombre }} {{ selectedVendedorForUpdate.apellidos }}
          </p>
        </div>
      </div>
    </ng-template>

    <!-- Contenido del modal -->
    <div class="location-update-content" *ngIf="selectedVendedorForUpdate">

      <!-- Información actual del vendedor -->
      <div class="current-info-card mb-4">
        <p-card>
          <ng-template pTemplate="header">
            <div class="card-header-custom">
              <i class="pi pi-info-circle text-blue-500"></i>
              <span class="font-semibold text-blue-700">Información Actual</span>
            </div>
          </ng-template>

          <div class="grid">
            <div class="col-12 md:col-6">
              <small class="text-color-secondary">Código:</small>
              <p class="mt-1 font-medium">{{ selectedVendedorForUpdate.codigo }}</p>
            </div>
            <div class="col-12 md:col-6">
              <small class="text-color-secondary">Estado:</small>
              <p class="mt-1 font-medium">
                <i [class]="'pi ' + (selectedVendedorForUpdate.estado === 'activo' ? 'pi-check-circle text-green-500' : 'pi-pause-circle text-red-500')"></i>
                {{ selectedVendedorForUpdate.estado || 'N/A' }}
              </p>
            </div>
            <div class="col-12">
              <small class="text-color-secondary">Dirección actual:</small>
              <p class="mt-1 font-medium">{{ selectedVendedorForUpdate.direccion || 'Sin dirección registrada' }}</p>
            </div>
          </div>
        </p-card>
      </div>



      <!-- Coordenadas -->
      <div class="coordinates-section">
        <h4 class="text-lg font-semibold mb-3 flex align-items-center gap-2">
          <i class="pi pi-globe text-primary"></i>
          Coordenadas
        </h4>

        <div class="grid">
          <!-- Latitud -->
          <div class="col-12 md:col-6">
            <div class="field">
              <label for="latitud" class="block text-sm font-medium mb-2">
                <i class="pi pi-arrow-up-down mr-1"></i>Latitud
              </label>
              <p-inputNumber
                id="latitud"
                [(ngModel)]="locationUpdateForm.latitud"
                [minFractionDigits]="6"
                [maxFractionDigits]="8"
                [min]="-90"
                [max]="90"
                [disabled]="isUpdatingLocation"
                placeholder="Ej: -0.186879"
                styleClass="w-full"
                [useGrouping]="false">
              </p-inputNumber>
              <small class="text-color-secondary">Rango: -90 a 90</small>
            </div>
          </div>

          <!-- Longitud -->
          <div class="col-12 md:col-6">
            <div class="field">
              <label for="longitud" class="block text-sm font-medium mb-2">
                <i class="pi pi-arrow-left-right mr-1"></i>Longitud
              </label>
              <p-inputNumber
                id="longitud"
                [(ngModel)]="locationUpdateForm.longitud"
                [minFractionDigits]="6"
                [maxFractionDigits]="8"
                [min]="-180"
                [max]="180"
                [disabled]="isUpdatingLocation"
                placeholder="Ej: -78.503194"
                styleClass="w-full"
                [useGrouping]="false">
              </p-inputNumber>
              <small class="text-color-secondary">Rango: -180 a 180</small>
            </div>
          </div>
        </div>

        <!-- Información de precisión -->
        <div class="precision-info mt-3" *ngIf="locationUpdateForm.precision > 0">
          <div class="bg-green-50 border-left-3 border-green-500 p-3">
            <div class="flex align-items-center gap-2">
              <i class="pi pi-check-circle text-green-600"></i>
              <span class="text-green-700 font-medium">
              Precisión GPS: ±{{ locationUpdateForm.precision | number:'1.0-0' }} metros
            </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Dirección -->
      <div class="field mt-4">
        <label for="direccion" class="block text-sm font-medium mb-2">
          <i class="pi pi-home mr-2"></i>Dirección (Opcional)
        </label>
        <input
          pInputText
          id="direccion"
          [(ngModel)]="locationUpdateForm.direccion"
          placeholder="Ingresa la dirección completa"
          [disabled]="isUpdatingLocation"
          class="w-full" />
      </div>

      <div class="loading-overlay" *ngIf="isUpdatingLocation">
        <div class="flex flex-column align-items-center justify-content-center gap-3">
          <p-progressSpinner [style]="{ width: '50px', height: '50px' }"></p-progressSpinner>
          <span class="text-lg font-medium text-primary">Actualizando ubicación...</span>
        </div>
      </div>
    </div>
    <ng-template pTemplate="footer">
      <div class="flex justify-content-between gap-2">
        <p-button
          label="Guardar Ubicación"
          icon="pi pi-save"
          [disabled]="isUpdatingLocation || !locationUpdateForm.latitud || !locationUpdateForm.longitud"
          [loading]="isUpdatingLocation"
          severity="primary">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>
</div>
