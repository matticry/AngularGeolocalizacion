<!-- src/app/features/reportes/geolocalizacion/geolocalizacion-reporte.component.html -->
<div class="vendedores-geoloc-container">
  <!-- Panel Izquierdo -->
  <div class="left-panel">
    <!-- Estado de carga/error -->
    <div class="status-section" *ngIf="loading() || error()">
      <div class="loading-indicator" *ngIf="loading()">
        <div class="spinner"></div>
        <span>Cargando vendedores...</span>
      </div>

      <div class="error-indicator" *ngIf="error()">
        <span class="error-icon">âš ï¸</span>
        <span>{{ error() }}</span>
        <button class="retry-btn" (click)="refresh()">Reintentar</button>
      </div>
    </div>


    <!-- Controles de filtrado -->
    <div class="controls-section" *ngIf="!loading()">
      <!-- Buscador mejorado -->
      <div class="search-box">
        <input
          type="text"
          placeholder="Buscar ubicaciÃ³n en Ecuador"
          class="w-full max-w-xs px-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm transition duration-300"
        />

        <button class="btn" (click)="filtrarVendedores()" [disabled]="loading()" aria-label="Buscar">
          <span>ğŸ”</span>
        </button>
      </div>

      <!-- Filtros compactos -->
      <div class="filter-estados">
        <button
          class="filter-chip"
          [class.active]="filtroEstado === 'todos'"
          (click)="onFiltroEstadoChange('todos')"
          [disabled]="loading()">
          Todos
        </button>
        <button
          class="filter-chip"
          [class.active]="filtroEstado === 'activo'"
          (click)="onFiltroEstadoChange('activo')"
          [disabled]="loading()">
          âœ“ Activos
        </button>
        <button
          class="filter-chip"
          [class.active]="filtroEstado === 'inactivo'"
          (click)="onFiltroEstadoChange('inactivo')"
          [disabled]="loading()">
          â¸ Inactivos
        </button>
      </div>
    </div>

    <!-- Lista de vendedores optimizada -->
    <div class="list-vendedores" *ngIf="!loading() && !error()">
      <div
        *ngFor="let v of vendedoresFiltrados; trackBy: trackByVendedorId"
        class="v-item"
        [class.selected]="selectedVendedorId === v.id"
        (click)="centrarEnVendedorClick(v)"
        [attr.aria-label]="'Vendedor ' + v.nombre + ' ' + (v.apellidos || '')"
        tabindex="0"
        (keydown.enter)="centrarEnVendedorClick(v)"
        (keydown.space)="centrarEnVendedorClick(v); $event.preventDefault()">

        <div class="v-info">
          <div class="v-name">
            <span class="name-primary">{{ v.nombre }}</span>
            <small *ngIf="v.apellidos" class="name-secondary">{{ v.apellidos }}</small>
            <span class="v-codigo">{{ v.codigo }}</span>
            <span class="v-status" [ngClass]="v.estado || 'default'">
              {{ getEstadoIcon(v.estado || 'default') }} {{ v.estado || 'Sin estado' }}
            </span>
          </div>

          <div class="v-meta">
            <div class="meta-row" *ngIf="v.direccion">
              ğŸ“ {{ v.direccion }}
            </div>
            <div class="meta-row" *ngIf="v.ciudad || v.zona">
              ğŸ¢ {{ v.ciudad || v.zona }}
            </div>
            <div class="meta-row" *ngIf="v.telefono">
              ğŸ“ {{ v.telefono }}
            </div>
            <div class="meta-row" *ngIf="v.ruc">
              ğŸ’¼ {{ v.ruc }}
            </div>
          </div>
          <!-- Eliminadas las estadÃ­sticas v-stats -->
        </div>
      </div>

      <!-- Estado vacÃ­o -->
      <div class="empty" *ngIf="vendedoresFiltrados.length === 0 && !loading()">
        <div class="empty-content">
          <span class="empty-icon">ğŸ”</span>
          <p>No se encontraron vendedores</p>
          <small *ngIf="searchTerm || filtroEstado !== 'todos'">
            Intenta con otro tÃ©rmino o ajusta los filtros
          </small>
          <small *ngIf="!searchTerm && filtroEstado === 'todos'">
            No hay vendedores registrados
          </small>
        </div>
      </div>
    </div>

    <!-- Controles de paginaciÃ³n con iconos -->
    <div class="pagination-controls" *ngIf="paginacion && paginacion.totalPaginas > 1 && !loading()">
      <button
        class="pagination-btn"
        [disabled]="!paginacion.tienePaginaAnterior"
        (click)="onPaginaAnterior()"
        aria-label="Anterior">
        <span class="material-icons">chevron_left</span>
      </button>

      <div class="pagination-info-detailed">
        <span>{{ paginacion.paginaActual }} / {{ paginacion.totalPaginas }}</span>
      </div>

      <button
        class="pagination-btn"
        [disabled]="!paginacion.tienePaginaSiguiente"
        (click)="onPaginaSiguiente()"
        aria-label="Siguiente">
        <span class="material-icons">chevron_right</span>
      </button>
    </div>
    <!-- InformaciÃ³n de paginaciÃ³n compacta -->
    <div class="pagination-info" *ngIf="paginacion && !loading()">
      <small>{{ getPaginaInicio() }} - {{ getPaginaFin() }} de {{ paginacion.totalRegistros }}</small>
    </div>


    <!-- Acciones compactas -->
    <div class="left-footer" *ngIf="!loading() && !error()">
      <button
        class="btn primary"
        (click)="mostrarTodas()"
        [disabled]="vendedoresFiltrados.length === 0"
        aria-label="Ver todos">
        ğŸŒ Ver Todos
      </button>
      <button
        class="btn ghost"
        (click)="obtenerMiUbicacion()"
        aria-label="Mi ubicaciÃ³n">
        ğŸ“ Mi UbicaciÃ³n
      </button>
    </div>
  </div>

  <!-- Panel Derecho - Mapa -->
  <div class="right-panel">
    <!-- Header simplificado -->
    <div class="map-header">
      <!-- InformaciÃ³n de vendedores -->
      <div class="header-vendedores">
        <div class="header-title">
          <h2>ğŸ‘¥ Vendedores</h2>
          <button class="refresh-btn" (click)="refresh()" [disabled]="loading()" title="Actualizar datos">
            <span [class.spinning]="loading()">ğŸ”„</span>
          </button>
        </div>
        <!-- Mostrar empresa seleccionada -->
        <div class="empresa-info" *ngIf="empresaSeleccionada">
          <small>ğŸ“Š {{ empresaNombre }}</small>
        </div>
      </div>

      <!-- Status del mapa -->
      <div class="header-mapa">
        <div class="status">
          <span [ngClass]="{'loading-shimmer': mapLoading}">{{ mapStatus }}</span>
          <span class="map-counter" *ngIf="!mapLoading && vendedoresFiltrados.length > 0">
            {{ vendedoresFiltrados.length }} vendedores
          </span>
        </div>
      </div>
    </div>

    <!-- Contenedor del mapa -->
    <div class="leaflet-map">
      <div id="geoloc-map" #mapContainer style="width: 100%; height: 100%;"></div>

      <!-- Leyenda flotante -->
      <div class="map-legend-floating" *ngIf="!loading() && !error() && vendedoresFiltrados.length > 0">
        <div class="legend-title">Leyenda</div>
        <div class="legend-item">
          <span class="legend-dot" style="background: #10b981;"></span>
          <span>Activos ({{ estadisticas.activos }})</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot" style="background: #ef4444;"></span>
          <span>Inactivos ({{ estadisticas.inactivos }})</span>
        </div>
        <div class="legend-item">
          <span class="legend-dot" style="background: #1976d2; animation: pulse 2s infinite;"></span>
          <span>Tu UbicaciÃ³n</span>
        </div>
      </div>

      <!-- Overlay de carga -->
      <div class="map-loading" *ngIf="mapLoading">
        <div class="spinner" aria-hidden="true"></div>
        <div>
          <strong>{{ mapStatus }}</strong>
          <br>
          <small>Preparando mapa con detalles de calles...</small>
        </div>
      </div>

      <!-- Overlay de error -->
      <div class="map-error" *ngIf="error() && !mapLoading">
        <div class="error-content">
          <span class="error-icon">âš ï¸</span>
          <strong>Error cargando datos</strong>
          <p>{{ error() }}</p>
          <button class="retry-btn" (click)="refresh()">Reintentar</button>
        </div>
      </div>

      <!-- Overlay sin datos -->
      <div class="map-no-data" *ngIf="!loading() && !error() && vendedoresFiltrados.length === 0 && !mapLoading">
        <div class="no-data-content">
          <span class="no-data-icon">ğŸ“</span>
          <strong>Sin vendedores para mostrar</strong>
          <p>No hay vendedores que coincidan con los filtros</p>
        </div>
      </div>
    </div>
  </div>
</div>
